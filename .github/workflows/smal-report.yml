name: SMAL Report

on:
  push:
    branches: [ smal-report ]
  pull_request:
    branches: [ smal-report ]
  workflow_dispatch:

jobs:
  smal-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: .

      - name: Show workspace
        run: |
          pwd
          ls -la

      - name: Ensure `cardinal/uxnsmal` is available
        run: |
          set -e
          echo "Checking for cardinal/uxnsmal..."
          if [ -d cardinal/uxnsmal ]; then
            echo "Found cardinal/uxnsmal in workspace.";
          elif [ -d ../uxnsmal ]; then
            echo "Found ../uxnsmal; copying into cardinal/uxnsmal";
            rm -rf cardinal/uxnsmal || true; cp -a ../uxnsmal cardinal/uxnsmal;
          elif [ -d uxnsmal ]; then
            echo "Found uxnsmal at repo root; copying into cardinal/uxnsmal";
            rm -rf cardinal/uxnsmal || true; cp -a uxnsmal cardinal/uxnsmal;
          else
            echo "Cloning uxnsmal into cardinal/uxnsmal";
            rm -rf cardinal/uxnsmal || true; git clone --depth 1 https://github.com/bbogdan-ov/uxnsmal.git cardinal/uxnsmal;
          fi

      - name: Verify cardinal contains uxnsmal
        run: |
          if [ ! -d cardinal/uxnsmal ]; then echo "cardinal/uxnsmal missing"; ls -la cardinal || true; exit 1; fi

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Build workspace (cardinal-gui)
        working-directory: cardinal
        run: cargo build -p cardinal-gui --verbose

      - name: Run smal_examples test
        working-directory: cardinal
        env:
          SMAL_TEST_STRICT: '1'
          SMAL_GUI_CAPTURE: '1'
          SMAL_GUI_TIMEOUT_MS: '15000'
        run: xvfb-run -a cargo test -p uxn-tal --features uses_uxnsmal --test smal_examples -- --nocapture

      - name: List smal-report files
        run: ls -R cardinal/uxn-tal/smal-report || true

      - name: Upload smal-report artifact
        uses: actions/upload-artifact@v4
        with:
          name: smal-report
          path: cardinal/uxn-tal/smal-report
