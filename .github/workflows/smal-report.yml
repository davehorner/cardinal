name: SMAL Report

on:
  push:
    branches: [ smal-report ]
  pull_request:
    branches: [ smal-report ]
  workflow_dispatch:

jobs:
  smal-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Build workspace (cardinal-gui)
        run: cargo build -p cardinal-gui --manifest-path cardinal/Cargo.toml --verbose

      - name: Run smal_examples test
        env:
          SMAL_TEST_STRICT: '1'
          SMAL_GUI_CAPTURE: '1'
          SMAL_GUI_TIMEOUT_MS: '15000'
        run: xvfb-run -a cargo test -p uxn-tal --features uses_uxnsmal --manifest-path cardinal/uxn-tal/Cargo.toml --test smal_examples -- --nocapture

      - name: List smal-report files
        run: ls -R cardinal/uxn-tal/smal-report || true

      - name: Upload smal-report artifact
        uses: actions/upload-artifact@v4
        with:
          name: smal-report
          path: cardinal/uxn-tal/smal-report
